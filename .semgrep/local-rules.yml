rules:
  # SQL Injection Basic Rule for WP
  - id: wp-sqlt-taint-basic
    message: >
      [보안 위험] 잠재적인 SQL Injection의 가능성이 있습니다.
      사용자 입력이 $wpdb->prepare()를 거치지 않고 $wpdb 함수로 전달되었습니다.
    languages: [php]
    severity: ERROR
    mode: taint
    metadata:
      cwe: "CWE-89: SQL Injection"
    pattern-sources:
      # 외부 입력이 들어오는 파라미터들, 오염된 상태로 간주하고 흐름 추적
      - pattern: $_GET[$X]
      - pattern: $_POST[$X]
      - pattern: $_REQUEST[$X]
    pattern-sanitizers:
      # WP 내에서 SQL Injection을 방지하는 입력값 필터링 함수들 명시
      - pattern: $wpdb->prepare()
      - pattern: esc_sql($X)
      - pattern: intval($X)
      - pattern: absint($X)
      - pattern: (int) $X
    pattern-sinks:
      # source에 명시된 파라미터들이 sanitizers를 거치지 않고 여기에 도달할 시
      # Semgrep에선 해당 Pattern을 취약점 포인트로 판단합니다.
      - pattern: $wpdb->query($SINK, ...)
      - pattern: $wpdb->get_results($SINK, ...)
      - pattern: $wpdb->get_var($SINK, ...)
      - pattern: $wpdb->get_row($SINK, ...)
      - pattern: $wpdb->get_col($SINK, ...)

  # Cross-Site Scripting Basic Rule for WP
  - id: wp-xss-taint-basic
    message: >
      [보안 위험] 잠재적인 XSS의 가능성이 있습니다.
      사용자의 입력이 필터링되지 않고 출력됩니다.
    languages: [php]
    severity: ERROR
    mode: taint
    metadata:
      cwe: "CWE-79 Cross-Site Scripting"
    pattern-sources:
      - pattern: $_GET[$X]
      - pattern: $_POST[$X]
      - pattern: $_REQUEST[$X]
      - pattern: $_COOKIE[$X]
    pattern-sanitizers:
      - pattern: esc_html($X) # HTML 필터링
      - pattern: esc_attr($X) # HTML 속성 필터링 ex.<img src="..">
      - pattern: esc_url($X) # URL 주소 필터링
      - pattern: esc_js($X) # 자바스크립트 코드 필터링
      - pattern: wp_kses($X, $ALLOWED) # 허용 태그, 코드만 필터링
      - pattern: wp_kses_post($X) # 일부 HTML 태그만 허용
      - pattern: sanitize_text_field($X) # 단순한 글자만 남김
      - pattern: sanitize_user($X, ...) # 사용자 이름에 허용되는 문자열만 사용
      - pattern: sanitize_email($X) # 유효한 이메일 주소만 사용
      - pattern: htmlspecialchars($X, ...) # HTML 특수문자 필터링
      - pattern: strip_tags($X) # 모든 <태그>제거
    pattern-sinks:
      - pattern: echo $SINK; # 화면 출력
      - pattern: print $SINK; # 화면 출력
      - pattern: printf($F, $SINK, ...); # 형식 지정 화면 출력
      - pattern: vprintf($F, $SINKS); # 데이터를 배열로 한번에 받아서 포멧에 맞춰 화면 출력
      - pattern: echo sprintf($F, $SINK, ...); # $F 형식에 맞춰 변수를 합친 문자열만 출력
      - pattern: print sprintf($F, $SINK, ...); # $F 형식에 맞춰 변수를 합친 문자열만 출력



  # CMD Injection Basic Rule for WP (Source 통합)
  - id: wp-command-injection-taint
    message: >
      [보안 위험] 치명적인 OS 커맨드 인젝션(RCE)입니다. 사용자 입력이나 원격 파일 내용이 시스템 명령어 함수로 전달되었습니다.
    languages: [php]
    severity: ERROR
    mode: taint
    metadata:
      cwe: "CWE-78: OS Command Injection"
    pattern-sources:
      # 1. 일반 사용자 입력
      - pattern: $_GET[$X]
      - pattern: $_POST[$X]
      - pattern: $_REQUEST[$X]
      - pattern: file_get_contents($SOURCE, ...) //오염 전파 부
      - pattern: file($SOURCE, ...)
      - pattern: readfile($SOURCE)
      - pattern: fopen($SOURCE, ...)

    pattern-sanitizers:
      - pattern: escapeshellcmd($X) # 쉘 명령어로 실행되지 않도록 필터링
      - pattern: escapeshellarg($X) # $X를 하나의 독립적인 인자로 변환
      - pattern: intval($X) # $X를 정수로 강제 변환
      - pattern: (int) $X # $X를 정수로 강제 변환

    pattern-sinks:
      - pattern: system($SINK, ...) # 외부 프로그램이나 시스템 명령어를 실행하고 화면 출력
      - pattern: exec($SINK, ...) # 외부 프로그램 실행 결과 마지막줄을 문자열로 반환
      - pattern: passthru($SINK, ...) # 외부 프로그램 실행 결과 화면 출력
      - pattern: shell_exec($SINK, ...) # 셀 명령어를 실행하고 전체 출력을 하나의 문자열로 반환
      - pattern: pcntl_exec($SINK, ...) # 현재 프로세스를 지정된 프로그램으로 교체 실행
      - pattern: popen($SINK, ...) #양방향 파이프를 열어 명령어와 데이터를 주고받음(결과 파일 포인터 형태 반환)
      - pattern: "`...$SINK...`" #백틱 안의 내용이 OS 명령으로 실행


# Code Injection Taint Rule (eval, assert)
  - id: wp-code-injection-taint-improved
    message: >
      [CRITICAL] 사용자 입력($SINK)이나 원격 파일 내용이 eval(), assert() 등의 PHP 코드 실행 함수에 전달되었습니다. (RCE 위험)
    languages: [php]
    severity: ERROR
    mode: taint
    metadata:
      cwe: "CWE-94: Improper Control of Generation of Code"
    pattern-sources:
      - pattern: $_GET[$X]
      - pattern: $_POST[$X]
      - pattern: $_REQUEST[$X]
      - pattern: $_COOKIE[$X]
      - pattern: file_get_contents($SOURCE, ...) //오염 전파 부분
      - pattern: file($SOURCE, ...)
      - pattern: readfile($SOURCE)
      - pattern: fopen($SOURCE, ...)
      
    pattern-sanitizers:
      - pattern: intval($X)
      - pattern: (int) $X
      - pattern: (bool) $X

    pattern-sinks:
      - pattern: eval($SINK);
      - pattern: assert($SINK, ...);
      - pattern: create_function($ARGS, $SINK);


  # Eval 사용 자체 경고 (Taint Flow 무관)
  - id: php-eval-usage-warning
    message: >
      [CRITICAL] eval() 함수가 사용되었습니다. eval()은 코드 인젝션 위험을 내포하므로 절대 사용해서는 안 됩니다.
    languages: [php]
    severity: ERROR
    pattern: eval($X);



  # Unrestricted Upload of File Rule for WP
  - id: wp-file-upload-move-raw
    message: >
      [보안 경고] 이 패턴 주변에 확장자 확인 로직이나, 파일 내용을 확인하는 MIME 타입 검사 로직이 있어야 안전합니다.
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-434: Unrestricted Upload of File with Dangerous Type"
    pattern-either:
      # 1. WP/PHP의 표준 파일 이동 함수
      - pattern: move_uploaded_file($_FILES[$X]['tmp_name'], $DEST);
      - pattern: wp_handle_upload($_FILES[$X], ...); 
      
      # 2. PclZip 추출 함수 (WP All Import와 같은 플러그인에서 사용)
      - pattern: |
          $archive = new PclZip($FILE);
          ...
          $v_result_list = $archive->extract(...);   

      # 3. ZipArchive 추출 함수 (PHP 내장 표준)
      - pattern: |
          $zip = new ZipArchive();
          ...
          $zip->extractTo($DEST);

  - id: wp-file-upload-into-webroot
    message: >
      [보안 경고] 파일 이름($DEST)을 생성할 때 sanitize_file_name()과 같은 함수를 사용하여 경로 조작을 막고,
      파일 이름을 안전하게 정화했는지 확인해야 합니다.
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-434: Unrestricted Upload of File with Dangerous Type"
    patterns:
      - pattern: |
          $dest = $DIR . $_FILES[$X]['name'];
          ...
          move_uploaded_file($_FILES[$X]['tmp_name'], $dest);
        # 파일 경로 생성 및 이동
        # 경로 조작, 웹 루트 저장의 가능성을 수동 확인
  

  # --- Cross-Site Request Forgery Rule for WP ---
  - id: wp-missing-nonce-check-admin-post-update_option # 인증 부재 시 임의의 설정 변경이 가능
    message: >
      [보안 위험] admin_post_ 액션으로 등록된 콜백에서 update_option 호출이 있습니다.
      Nonce 체크(check_admin_referer 등)가 있는지 수동으로 확인하세요.
    languages: [php]
    severity: WARNING
    pattern: |
      function $FUNC(...) {
        ...
      }
      ...
      add_action('admin_post_...', $FUNC);
      ...
      update_option(...);

  - id: wp-missing-nonce-check-admin-post-delete_option # 인증 부재 시 임의의 설정 삭제갸 가능
    message: >
      [보안 위험] admin_post_ 액션으로 등록된 콜백에서 delete_option 호출이 있습니다.
      Nonce 체크 존재 여부를 확인하세요.
    languages: [php]
    severity: WARNING
    pattern: |
      function $FUNC(...) {
        ...
      }
      ...
      add_action('admin_post_...', $FUNC);
      ...
      delete_option(...);

  - id: wp-missing-nonce-check-wp-ajax-update_option # AJAX 요청을 위조해 설정 변경 가능
    message: >
      [보안 위험] wp_ajax_ 액션으로 등록된 콜백에서 update_option 호출이 있습니다.
      Nonce 체크 존재 여부를 확인하세요.
    languages: [php]
    severity: WARNING
    pattern: |
      function $FUNC(...) {
        ...
      }
      ...
      add_action('wp_ajax_...', $FUNC);
      ...
      update_option(...);

  - id: wp-missing-nonce-check-wp-ajax-delete_option  # AJAX 요청을 위조해 설정 삭제 가능
    message: >
      [보안 위험] wp_ajax_ 액션으로 등록된 콜백에서 delete_option 호출이 있습니다.
      Nonce 체크 존재 여부를 확인하세요.
    languages: [php]
    severity: ERROR
    pattern: |
      function $FUNC(...) {
        ...
      }
      ...
      add_action('wp_ajax_...', $FUNC);
      ...
      delete_option(...);


  # API Insecure Permission Rule for WP
  # 무조건 허용(Allow All) 권한 설정 탐지
  - id: wp-rest-api-allow-all
    message: >
      [보안 위험] REST API 권한 검사(permission_callback) 누락 가능성.
      permission_callback이 '__return_true'로 설정되었거나 register_rest_route에
      인자가 직접 전달되는 경우를 탐지합니다. (수동 확인 필요)
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-862: Missing Authorization"
      project-focus: "권한상승, 인증우회"
    pattern-either:
      - pattern: |
          register_rest_route(..., ..., [
            ...,
            'permission_callback' => '__return_true',
            ...
          ]);
      - pattern: |
          register_rest_route(..., ..., $ARGS);


  # 콜백 함수 내 권한 검사 누락 탐지 (Taint-like 구조)
  - id: wp-rest-api-dangerous-callback-no-permission
    message: >
      [보안 위험] REST API 콜백 함수에 update_option() 같은 위험한 함수가 포함되어 있지만,
      권한 검사 함수(current_user_can)가 누락되었습니다. (수동 확인 필요)
    languages: [php]
    severity: WARNING
    metadata:
      cwe: "CWE-862: Missing Authorization"
      project-focus: "권한상승, 인증우회"
    patterns:
      # 1. 관리자 전용 기능(Sink)을 포함하는 함수를 찾음
      - pattern: |
          function $FUNC(...) {
            ...
            update_option(...); # <-- 민감한 작업 (Sink)
            ...
          }
      # 2. 그 함수가 REST API에 등록되었음을 찾음
      - pattern: |
          register_rest_route(..., ..., [
            ...,
            'callback' => '$FUNC',
            ...
          ]);
      # 3. 권한 검사 함수(Sanitizer 역할)가 사용되지 않았음을 확인 (Not-pattern 사용)
      - pattern-not: |
          function $FUNC(...) {
            ...
            current_user_can(...); # <-- 권한 검사 함수 (Sanitizer)
            ...
          }
