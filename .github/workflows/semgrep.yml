name: Semgrep

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (ë””ë²„ê·¸) ì‹¤ì œë¡œ ìŠ¤ìº”ë  PHP íŒŒì¼ í™•ì¸
      - name: List PHP files
        run: |
          echo "Repo root: $PWD"
          find . -type f -name "*.php" | head -n 200
          echo "Total PHP files:"
          find . -type f -name "*.php" | wc -l

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Semgrep & jq
        run: |
          pip install --upgrade pip semgrep
          sudo apt-get update && sudo apt-get install -y jq

      # ì„¤ì • íŒŒì¼(.semgrep/.semgrep.yml â†’ .semgrep.yml â†’ auto) ê°ì§€ + ë¦¬í¬íŠ¸ í´ë” ì¤€ë¹„
      - name: Prepare config & reports dir
        shell: bash
        run: |
          set -e
          if [ -f ".semgrep/.semgrep.yml" ]; then
            CONFIG_FILE=".semgrep/.semgrep.yml"
          elif [ -f ".semgrep.yml" ]; then
            CONFIG_FILE=".semgrep.yml"
          else
            CONFIG_FILE="auto"
          fi
          echo "CONFIG=$CONFIG_FILE" >> "$GITHUB_ENV"
          mkdir -p reports

          echo "== CONFIG chosen =="
          echo "$CONFIG_FILE"

          echo "== List .semgrep dir (if any) =="
          ls -la .semgrep || true

          echo "== Show config (if file) =="
          if [ -f "$CONFIG_FILE" ]; then
            sed -n '1,200p' "$CONFIG_FILE"
          fi



      - name: Run Semgrep
        run: |
          set -e
          echo "=== Scanning target files ==="
          ls -R src/wp-plugins || true
          echo "=== Running Semgrep with custom rules ==="
          semgrep scan \
            --config ".semgrep/.semgrep.yml" \
            --metrics=off --timeout 10 \
            --sarif -o reports/semgrep.sarif \
            --verbose \
            --debug \
            src/wp-plugins


      # JSON ì¶œë ¥ (ì—ëŸ¬ ìˆ¨ê¹€ ì—†ìŒ)
      - name: Semgrep JSON (debug mode â€” show stderr)
        shell: bash
        run: |
          set -x
          echo "=== semgrep version ==="
          semgrep --version || true
          echo

          echo "=== show CONFIG env ==="
          echo "CONFIG='$CONFIG'"
          echo

          echo "=== list .semgrep dir & files ==="
          ls -la .semgrep || true
          echo "=== show .semgrep/.semgrep.yml ==="
          sed -n '1,200p' .semgrep/.semgrep.yml || true
          echo

          echo "=== attempt semgrep with --debug (capture stdout/stderr) ==="
          mkdir -p reports
          semgrep scan --config "$CONFIG" --metrics=off --timeout 10 --json -o reports/semgrep.json --debug > reports/semgrep-debug.out 2> reports/semgrep-debug.err || true

          echo "---- semgrep stdout (last 200 lines) ----"
          tail -n 200 reports/semgrep-debug.out || true
          echo "---- semgrep stderr (last 200 lines) ----"
          tail -n 200 reports/semgrep-debug.err || true

          if [ -s reports/semgrep.json ]; then
            echo "JSON produced with $(jq '.results | length' reports/semgrep.json) results"
          else
            echo "No JSON produced"
          fi

          # fail if semgrep exit code was non-zero (remove if you want it to continue)
          RET=$?
          echo "SEMgrep exit code: $RET"
          exit $RET


      # Semgrep SARIF (ì‹œë„í•˜ë˜ ì‹¤íŒ¨í•´ë„ ì—ëŸ¬ ì¶œë ¥ íŒŒì¼ì„ ë‚¨ê¸°ê³  ê³„ì† ì§„í–‰)
      - name: Semgrep SARIF (attempt, capture stderr)
        shell: bash
        run: |
          set -x
          mkdir -p reports
          # í™˜ê²½ ì¸ì½”ë”© ê°•ì œ (ì¸ì½”ë”© ë¬¸ì œ ì˜ˆë°©)
          export LC_ALL=en_US.UTF-8
          export LANG=en_US.UTF-8
          export PYTHONUTF8=1

          # ì‹œë„í•˜ë©´ì„œ stdout/stderr íŒŒì¼ì— ì €ìž¥
          semgrep scan --config ".semgrep/.semgrep.yml" \
            --metrics=off --timeout 10 \
            --sarif -o reports/semgrep.sarif > reports/semgrep-sarif.out 2> reports/semgrep-sarif.err || true

          echo "=== semgrep SARIF stdout (tail) ==="
          tail -n 200 reports/semgrep-sarif.out || true
          echo "=== semgrep SARIF stderr (tail) ==="
          tail -n 200 reports/semgrep-sarif.err || true

          # ë§Œì•½ ì§ì ‘ ìƒì„±í•œ reports/semgrep.sarifì´ ì—†ìœ¼ë©´(semgrep ì‹¤íŒ¨ ë“±), reports í´ë”ì—ì„œ ì²«ë²ˆì§¸ sarif íŒŒì¼ì„ ì°¾ì•„ semgrep.sarifë¡œ ë³µì‚¬/ì´ë™
          if [ ! -f reports/semgrep.sarif ]; then
            FOUND=$(find reports -maxdepth 1 -type f -name '*.sarif' | head -n1 || true)
            if [ -n "$FOUND" ]; then
              echo "Found existing sarif: $FOUND -> normalize to reports/semgrep.sarif"
              mv -f "$FOUND" reports/semgrep.sarif
            else
              echo "No sarif file found after semgrep --sarif attempt"
            fi
          else
            echo "reports/semgrep.sarif exists (created by semgrep)"
          fi

      # SARIF ì—…ë¡œë“œ: íŒŒì¼ì´ ìžˆìœ¼ë©´ ì—…ë¡œë“œ, ì—†ìœ¼ë©´ ê²½ê³ ë§Œ ë‚¨ê¹€
      - name: Upload SARIF (if exists)
        if: always()
        run: |
          if [ -f reports/semgrep.sarif ]; then
            echo "Uploading SARIF to GitHub code scanning..."
            gh api --method POST -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/code-scanning/sarifs \
              -F "sarif=@reports/semgrep.sarif" \
              -F "commit_sha=${{ github.sha }}" || true
            echo "Note: If you prefer using github/codeql-action/upload-sarif, replace this step."
          else
            echo "No reports/semgrep.sarif found â€” skipping upload"
            ls -la reports || true
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # í•­ìƒ ë¦¬í¬íŠ¸ ë³´ì¡´ (ì•„í‹°íŒ©íŠ¸)
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: reports/*
          if-no-files-found: warn
          retention-days: 14



      # GitHub Actions Job Summaryì— í•­ìƒ ìš”ì•½ ì¶œë ¥
      - name: Write Markdown Summary
        if: always()
        run: |
          echo "## ðŸ§ª Semgrep Summary" >> "$GITHUB_STEP_SUMMARY"

          if [ -s reports/semgrep.json ]; then
            TOTAL=$(jq '.results | length' reports/semgrep.json)
            echo "- Total findings: **$TOTAL**" >> "$GITHUB_STEP_SUMMARY"

            for sev in ERROR WARNING INFO; do
              COUNT=$(jq --arg sev "$sev" '[.results[] | select(.extra.severity==$sev)] | length' reports/semgrep.json)
              echo "  - $sev: **$COUNT**" >> "$GITHUB_STEP_SUMMARY"
            done

            echo -e "\n### Top findings (up to 10)\n" >> "$GITHUB_STEP_SUMMARY"
            jq -r '
              .results[]
              | {check_id, path: .path, start: .start.line, message: .extra.message, severity: .extra.severity}
              | "| \(.severity) | \(.check_id) | \(.path):\(.start) | \(.message | gsub("\\n"; " ")) |"
            ' reports/semgrep.json | head -n 10 >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Semgrep produced no JSON (likely no files matched). Check the **List PHP files** step above." >> "$GITHUB_STEP_SUMMARY"
          fi


